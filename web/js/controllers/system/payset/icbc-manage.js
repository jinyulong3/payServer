app.controller("icbcManage",["$scope","$uibModal","toaster","httpJsonHandle","myConstants","$translate",function(n,e,o,p,l,t){n.selected_group_id="0",n.rsas=["RSA","RSA2"],n.app.myData.groupListNoAll=n.app.myData.groupList.slice(0),console.log(n.app.myData.groupListNoAll),"0"==n.app.myData.groupListNoAll[0].group_id&&n.app.myData.groupListNoAll.splice(0,1),console.log(n.app.myData.groupListNoAll),n.default_search_select_station_list={station_id:"0",stationName:t.instant("public.all")},n.search_select_station_list=[n.default_search_select_station_list],n.selected_station_id="0",l.getStationListSendData.sessionId=n.app.myData.sessionId,0!=n.app.myData.role&&(n.selected_group_id=n.app.myData.groupListNoAll[0].group_id),n.getAliSetListSendData={sessionId:n.app.myData.sessionId,tableName:"view_station_group_icbc_config",fields:[],where:"",limit:"",offset:""},2==n.app.myData.role&&(n.getAliSetListSendData.where=" group_id='"+n.app.myData.groupId+"' AND station_id='"+n.app.myData.stationId+"'"),n.filterOptions={filterText:"",useExternalFilter:!0},n.totalServerItems=0,n.pagingOptions={pageSizes:[10,15,25,50,100],pageSize:15,currentPage:1},n.columnDefs=[{field:"group_id",displayName:t.instant("items.customerManage.group_id"),width:"*"},{field:"groupName",displayName:t.instant("items.customerManage.groupName"),width:"*"},{field:"station_id",displayName:t.instant("items.stationManage.station_id"),width:"*"},{field:"stationName",displayName:t.instant("items.stationManage.stationName"),width:"*"},{field:"mer_id",displayName:"商户号",width:"*"},{field:"app_id",displayName:"appid",width:"*"},{field:"aes_key",displayName:"AES密钥",width:"*"},{field:"time_insert",displayName:t.instant("items.payset.time_insert"),width:"*",cellFilter:"filterDateStringSplitMs"},{field:"time_update",displayName:t.instant("items.payset.time_update"),width:"*",cellFilter:"filterDateStringSplitMs"}],n.callback=function(t){n.myData=t.fieldValues,n.totalServerItems=t.allCount,o.clear()},n.setPagingData=function(t,a){n.getAliSetListSendData.offset=1==t?0:(t-1)*a,n.getAliSetListSendData.limit=a,p.myPost2(l.URL.systemUrl,n.getAliSetListSendData,l.msgIdName.normalSelectMsgId,l.msgIdName.normalSelectMsgName,n.callback)},n.getPagedDataAsync=function(t,a,e){setTimeout(function(){o.pop("wait",constantsLang[n.app.myData.lang].load.reqData,constantsLang[n.app.myData.lang].load.loadingData),n.setPagingData(a,t)},100)},n.getPagedDataAsync(n.pagingOptions.pageSize,n.pagingOptions.currentPage),n.$watch("pagingOptions",function(t,a){t!==a&&n.getPagedDataAsync(n.pagingOptions.pageSize,n.pagingOptions.currentPage,n.filterOptions.filterText)},!0),n.$watch("filterOptions",function(t,a){t!==a&&n.getPagedDataAsync(n.pagingOptions.pageSize,n.pagingOptions.currentPage,n.filterOptions.filterText)},!0),n.gridOptions={i18n:"undefined"!=n.app.myData.lang?n.app.myData.lang:"zh-cn",data:"myData",enablePaging:!0,showFooter:!0,footerRowHeight:40,totalServerItems:"totalServerItems",pagingOptions:n.pagingOptions,enableColumnResizing:!0,rowHeight:28,enableRowSelection:!0,multiSelect:!1,columnDefs:"columnDefs",enableColumnResize:!0,showSelectionCheckbox:!0,filterOptions:n.filterOptions},n.callback_getStationList=function(t){n.search_select_station_list=n.search_select_station_list.concat(t.fieldValues),"0"!=n.selected_group_id?n.getAliSetListSendData.where=" group_id='"+n.selected_group_id+"'":n.getAliSetListSendData.where="",1!=n.pagingOptions.currentPage&&(n.pagingOptions.currentPage=1)},n.selectCustomerChange=function(){console.log(n.selected_group_id),n.search_select_station_list=[n.default_search_select_station_list],"0"!=n.selected_group_id?(l.getStationListSendData.where=" group_id='"+n.selected_group_id+"'",n.pagingOptions.currentPage=1,n.getAliSetListSendData.where=" group_id='"+n.selected_group_id+"'"):(l.getStationListSendData.where="",n.pagingOptions.currentPage=1,n.getAliSetListSendData.where=""),0==n.app.myData.role&&n.getPagedDataAsync(n.pagingOptions.pageSize,n.pagingOptions.currentPage),p.myPost2(l.URL.systemUrl,l.getStationListSendData,l.msgIdName.normalSelectMsgId,l.msgIdName.normalSelectMsgName,n.callback_getStationList)},1==n.app.myData.role&&n.selectCustomerChange(),n.selectStationChange=function(){console.log(n.selected_group_id),"0"!=n.selected_station_id?n.getAliSetListSendData.where=" station_id='"+n.selected_station_id+"'":"0"!=n.selected_group_id?n.getAliSetListSendData.where=" group_id='"+n.selected_group_id+"'":n.getAliSetListSendData.where="",1!=n.pagingOptions.currentPage?n.pagingOptions.currentPage=1:n.getPagedDataAsync(n.pagingOptions.pageSize,n.pagingOptions.currentPage)},app.controller("btnClickAddStationCon",["$scope","$uibModalInstance","info","parentScope",function(t,a,e,n){t.parent=n,t.info=e,t.ok=function(){t.info.sessionId=n.app.myData.sessionId,t.info.datatype=l.cmdType.ADD,t.info.paySetType=3,t.callback2=function(t){o.clear(),o.pop("success",constantsLang[n.app.myData.lang].tips.success,constantsLang[n.app.myData.lang].tips.addSuccess,l.TIMEOUT.timeout1s),a.dismiss(0),n.getPagedDataAsync(n.pagingOptions.pageSize,n.pagingOptions.currentPage,n.filterOptions.filterText)},p.myPost2(l.URL.systemUrl,t.info,l.msgIdName.paySetMsgId,l.msgIdName.paySetMsgName,t.callback2,a),o.pop("wait",constantsLang[n.app.myData.lang].load.reqData,constantsLang[n.app.myData.lang].load.addingData)},t.cancel=function(){console.log(t.info),a.dismiss(0)}}]),n.btnClickAddStation=function(){var t=n.gridOptions.$gridScope.selectedItems;if(0==t.length)o.pop("info",constantsLang[n.app.myData.lang].tips.tip,constantsLang[n.app.myData.lang].tips.noSelectRow);else if(null==t[0].station_id)o.pop("info",constantsLang[n.app.myData.lang].tips.tip,constantsLang[n.app.myData.lang].tips.noAddedStation);else if(null!=t[0].mer_id)o.pop("info",constantsLang[n.app.myData.lang].tips.tip,constantsLang[n.app.myData.lang].tips.isAddedToEdit);else{var a=n;e.open({templateUrl:"tpl/system/payset/icbc/addIcbc.html",controller:"btnClickAddStationCon",size:"md",resolve:{parentScope:a,info:function(){return t[0]}}})}},app.controller("btnClickEditStationCon",["$scope","$uibModalInstance","info","parentScope",function(t,a,e,n){t.parent=n,t.info=e,t.info.icbcSetData={},t.info.icbcSetData.app_id=e.app_id,t.info.icbcSetData.mer_id=e.mer_id,t.info.icbcSetData.aes_key=e.aes_key,t.ok=function(){t.info.sessionId=n.app.myData.sessionId,t.info.datatype=l.cmdType.CHANGE,t.info.paySetType=3,console.log(t.info),t.callback3=function(e){o.clear(),o.pop("success",constantsLang[n.app.myData.lang].tips.success,constantsLang[n.app.myData.lang].tips.editSuccess,l.TIMEOUT.timeout1s),a.dismiss(0),void 0!==n.app.myData.stationList&&n.app.myData.stationList.forEach(function(t,a){t.station_id==e.station_id&&(n.app.myData.stationList[a].stationName=e.stationName)}),n.getPagedDataAsync(n.pagingOptions.pageSize,n.pagingOptions.currentPage,n.filterOptions.filterText)},p.myPost2(l.URL.systemUrl,t.info,l.msgIdName.paySetMsgId,l.msgIdName.paySetMsgName,t.callback3,a),o.pop("wait",constantsLang[n.app.myData.lang].load.reqData,constantsLang[n.app.myData.lang].load.editingData)},t.cancel=function(){a.dismiss(0)}}]),n.btnClickEditStation=function(){var t=n.gridOptions.$gridScope.selectedItems;if(console.log(t[0]),0==t.length)o.pop("info",constantsLang[n.app.myData.lang].tips.tip,constantsLang[n.app.myData.lang].tips.noSelectRow);else if(null==t[0].station_id)o.pop("info",constantsLang[n.app.myData.lang].tips.tip,constantsLang[n.app.myData.lang].tips.noAddedStation);else if(null==t[0].mer_id)o.pop("info",constantsLang[n.app.myData.lang].tips.tip,constantsLang[n.app.myData.lang].tips.isAddedToEdit);else{var a=n;e.open({templateUrl:"tpl/system/payset/icbc/editIcbc.html",controller:"btnClickEditStationCon",size:"md",resolve:{parentScope:a,info:function(){return t[0]}}})}},app.controller("btnClickDelStationCon",["$scope","$uibModalInstance","info","parentScope",function(t,a,e,n){t.info=e,t.ok=function(){t.info.sessionId=n.app.myData.sessionId,t.info.datatype=l.cmdType.DEL,t.info.paySetType=3,t.callback3=function(t){o.clear(),o.pop("success",constantsLang[n.app.myData.lang].tips.success,constantsLang[n.app.myData.lang].tips.deleteSuccess,l.TIMEOUT.timeout1s),a.dismiss(0),n.getPagedDataAsync(n.pagingOptions.pageSize,n.pagingOptions.currentPage,n.filterOptions.filterText)},p.myPost2(l.URL.systemUrl,t.info,l.msgIdName.paySetMsgId,l.msgIdName.paySetMsgName,t.callback3,a),o.pop("wait",constantsLang[n.app.myData.lang].load.reqData,constantsLang[n.app.myData.lang].load.deletingData)},t.cancel=function(){a.dismiss(0)}}]),n.btnClickDelStation=function(){var t=n.gridOptions.$gridScope.selectedItems;if(0==t.length)o.pop("info",constantsLang[n.app.myData.lang].tips.tip,constantsLang[n.app.myData.lang].tips.noSelectRow);else if(null==t[0].station_id)o.pop("info",constantsLang[n.app.myData.lang].tips.tip,constantsLang[n.app.myData.lang].tips.noAddedStation);else if(null==t[0].mer_id)o.pop("info",constantsLang[n.app.myData.lang].tips.tip,constantsLang[n.app.myData.lang].tips.isAddedToEdit);else{var a=n;e.open({templateUrl:"tpl/system/payset/icbc/delIcbc.html",controller:"btnClickDelStationCon",size:"md",resolve:{parentScope:a,info:function(){return t[0]}}})}},app.controller("btnClickTestIcbcPayCon",["$scope","$uibModalInstance","info","parentScope",function(n,s,t,i){n.info=t,n.ok=function(){n.out_trade_no="",n.hasQrcode=!1,n.tips="222";var t=document.getElementById("qrcode_wx");t.innerText="";var e=new QRCode(t,{width:200,height:200}),a={};a.groupId=n.info.group_id,a.stationId=n.info.station_id,a.deviceId="测试工行支付web端",a.clientType=3,n.callback_2=function(t){if(console.log(t),0==t.error){var a=t.data.twoCodeVal;console.log(a),n.out_trade_no=t.data.tradeNo,e.makeCode(a),n.hasQrcode=!0}else o.pop("error",constantsLang[i.app.myData.lang].tips.error,t.errorMsg,l.TIMEOUT.timeout1s)},p.myPost(l.URL.systemPayUrl,a,l.msgIdName.payLoginMsgId,l.msgIdName.payLoginMsgName).then(function(t){switch(console.log(t),t.data.resCode){case l.resCode.SUCCESS:!function(t){n.sessionId=t.data.data.sessionId;var a={payType:9,subject:"web端工行支付二维码测试",body:"测试支付1分钱",transNo:"00001",amountPay:1};a.sessionId=n.sessionId,p.myPost2(l.URL.systemPayUrl,a,l.msgIdName.payReqPayQRcodeMsgId,l.msgIdName.payReqPayQRcodeMsgName,n.callback_2,s)}(t);break;default:o.pop("error",constantsLang[i.app.myData.lang].tips.error,t.data.resMsg,l.TIMEOUT.timeout1s)}},function(t){o.pop("error",constantsLang[i.app.myData.lang].tips.error,t,l.TIMEOUT.timeout1s)})},n.callback_4=function(t){console.log(t),0==t.error?(o.pop("success",constantsLang[i.app.myData.lang].tips.success,"退款成功，测试完成。该站点支付宝配置正确，可以正常使用！",l.TIMEOUT.timeout1s),s.dismiss()):o.pop("warning",constantsLang[i.app.myData.lang].tips.wran,t.errorMsg,l.TIMEOUT.timeout1s)},n.callback_3=function(t){if(console.log(t),0==t.error){var a={payType:2,amountPay:1,amountRefund:1};a.tradeNo=n.out_trade_no,a.sessionId=n.sessionId,p.myPost2(l.URL.systemPayUrl,a,l.msgIdName.payReqRefundQRcodeMsgId,l.msgIdName.payReqRefundQRcodeMsgName,n.callback_4,s)}else o.pop("warning",constantsLang[i.app.myData.lang].tips.wran,t.errorMsg,l.TIMEOUT.timeout1s)},n.refund=function(){if(n.hasQrcode)if(""==n.out_trade_no)o.pop("warning",constantsLang[i.app.myData.lang].tips.warn,"未能取到正确商户订单号",l.TIMEOUT.timeout1s);else{var t={};t.tradeNo=n.out_trade_no,t.sessionId=n.sessionId,p.myPost2(l.URL.systemPayUrl,t,l.msgIdName.payReqPayResultMsgId,l.msgIdName.payReqPayResultMsgName,n.callback_3,s)}else o.pop("warning",constantsLang[i.app.myData.lang].tips.wran,"还未获取到二维码",l.TIMEOUT.timeout1s)},n.cancel=function(){s.dismiss(0)}}]),n.btTestIcbcPay=function(){var t=n.gridOptions.$gridScope.selectedItems;if(0==t.length)o.pop("info",constantsLang[n.app.myData.lang].tips.tip,constantsLang[n.app.myData.lang].tips.noSelectRow);else if(null==t[0].station_id)o.pop("info",constantsLang[n.app.myData.lang].tips.tip,constantsLang[n.app.myData.lang].tips.noAddedStation);else if(null==t[0].mer_id)o.pop("info",constantsLang[n.app.myData.lang].tips.tip,constantsLang[n.app.myData.lang].tips.noAdded);else{var a=n;e.open({templateUrl:"tpl/system/payset/icbc/testIcbcPay.html",controller:"btnClickTestIcbcPayCon",size:"md",resolve:{parentScope:a,info:function(){return t[0]}}})}}}]);