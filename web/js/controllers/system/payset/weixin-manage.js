app.controller("weixinManage",["$scope","$uibModal","toaster","httpJsonHandle","myConstants","$translate","$http",function(n,e,l,c,d,t,a){n.selected_group_id="0",n.app.myData.groupListNoAll=n.app.myData.groupList.slice(0),console.log(n.app.myData.groupListNoAll),"0"==n.app.myData.groupListNoAll[0].group_id&&n.app.myData.groupListNoAll.splice(0,1),console.log(n.app.myData.groupListNoAll),n.default_search_select_station_list={station_id:"0",stationName:t.instant("public.all")},n.search_select_station_list=[n.default_search_select_station_list],n.selected_station_id="0",d.getStationListSendData.sessionId=n.app.myData.sessionId,0!=n.app.myData.role&&(n.selected_group_id=n.app.myData.groupListNoAll[0].group_id),n.getWxSetListSendData={sessionId:n.app.myData.sessionId,tableName:"view_station_group_wx_config",fields:[],where:"",limit:"",offset:""},2==n.app.myData.role&&(n.getWxSetListSendData.where=" group_id='"+n.app.myData.groupId+"' AND station_id='"+n.app.myData.stationId+"'"),n.filterOptions={filterText:"",useExternalFilter:!0},n.totalServerItems=0,n.pagingOptions={pageSizes:[10,15,25,50,100],pageSize:15,currentPage:1},n.columnDefs=[{field:"group_id",displayName:t.instant("items.customerManage.group_id"),width:"*"},{field:"groupName",displayName:t.instant("items.customerManage.groupName"),width:"*"},{field:"station_id",displayName:t.instant("items.stationManage.station_id"),width:"*"},{field:"stationName",displayName:t.instant("items.stationManage.stationName"),width:"*"},{field:"wx_APPID",displayName:t.instant("items.payset.wx_APPID"),width:"*"},{field:"sub_appid",displayName:t.instant("items.payset.sub_appid"),width:"*"},{field:"wx_MCHID",displayName:t.instant("items.payset.wx_MCHID"),width:"*"},{field:"sub_mch_id",displayName:t.instant("items.payset.sub_mch_id"),width:"*"},{field:"wx_p12_PATH",displayName:t.instant("items.payset.wx_p12_PATH"),width:"*",cellFilter:"filterWxP12:this"},{field:"time_insert",displayName:t.instant("items.payset.time_insert"),width:"*",cellFilter:"filterDateStringSplitMs"},{field:"time_update",displayName:t.instant("items.payset.time_update"),width:"*",cellFilter:"filterDateStringSplitMs"}],n.callback=function(t){n.myData=t.fieldValues,n.totalServerItems=t.allCount,l.clear()},n.setPagingData=function(t,a){n.getWxSetListSendData.offset=1==t?0:(t-1)*a,n.getWxSetListSendData.limit=a,c.myPost2(d.URL.systemUrl,n.getWxSetListSendData,d.msgIdName.normalSelectMsgId,d.msgIdName.normalSelectMsgName,n.callback)},n.getPagedDataAsync=function(t,a,e){setTimeout(function(){l.pop("wait",constantsLang[n.app.myData.lang].load.reqData,constantsLang[n.app.myData.lang].load.loadingData),n.setPagingData(a,t)},100)},n.getPagedDataAsync(n.pagingOptions.pageSize,n.pagingOptions.currentPage),n.$watch("pagingOptions",function(t,a){t!==a&&n.getPagedDataAsync(n.pagingOptions.pageSize,n.pagingOptions.currentPage,n.filterOptions.filterText)},!0),n.$watch("filterOptions",function(t,a){t!==a&&n.getPagedDataAsync(n.pagingOptions.pageSize,n.pagingOptions.currentPage,n.filterOptions.filterText)},!0),n.gridOptions={i18n:"undefined"!=n.app.myData.lang?n.app.myData.lang:"zh-cn",data:"myData",enablePaging:!0,showFooter:!0,footerRowHeight:40,totalServerItems:"totalServerItems",pagingOptions:n.pagingOptions,enableColumnResizing:!0,rowHeight:28,enableRowSelection:!0,multiSelect:!1,columnDefs:"columnDefs",enableColumnResize:!0,showSelectionCheckbox:!0,filterOptions:n.filterOptions},n.callback_getStationList=function(t){n.search_select_station_list=n.search_select_station_list.concat(t.fieldValues),"0"!=n.selected_group_id?n.getWxSetListSendData.where=" group_id='"+n.selected_group_id+"'":n.getWxSetListSendData.where="",1!=n.pagingOptions.currentPage&&(n.pagingOptions.currentPage=1)},n.selectCustomerChange=function(){console.log(n.selected_group_id),n.search_select_station_list=[n.default_search_select_station_list],"0"!=n.selected_group_id?(d.getStationListSendData.where=" group_id='"+n.selected_group_id+"'",n.pagingOptions.currentPage=1,n.getWxSetListSendData.where=" group_id='"+n.selected_group_id+"'"):(d.getStationListSendData.where="",n.pagingOptions.currentPage=1,n.getWxSetListSendData.where=""),0==n.app.myData.role&&n.getPagedDataAsync(n.pagingOptions.pageSize,n.pagingOptions.currentPage),c.myPost2(d.URL.systemUrl,d.getStationListSendData,d.msgIdName.normalSelectMsgId,d.msgIdName.normalSelectMsgName,n.callback_getStationList)},1==n.app.myData.role&&n.selectCustomerChange(),n.selectStationChange=function(){console.log(n.selected_group_id),"0"!=n.selected_station_id?n.getWxSetListSendData.where=" station_id='"+n.selected_station_id+"'":"0"!=n.selected_group_id?n.getWxSetListSendData.where=" group_id='"+n.selected_group_id+"'":n.getWxSetListSendData.where="",1!=n.pagingOptions.currentPage?n.pagingOptions.currentPage=1:n.getPagedDataAsync(n.pagingOptions.pageSize,n.pagingOptions.currentPage)},n.mchModes=[{id:1,name:"直连商户模式"},{id:2,name:"服务商模式"}],app.controller("btnClickAddStationCon",["$scope","$uibModalInstance","info","parentScope",function(t,a,e,n){t.parent=n,t.info=e,t.selectMchMode=function(){console.log(t.mchMode)},t.ok=function(){t.info.sessionId=n.app.myData.sessionId,t.info.datatype=d.cmdType.ADD,t.info.paySetType=1,t.callback2=function(t){l.clear(),l.pop("success",constantsLang[n.app.myData.lang].tips.success,constantsLang[n.app.myData.lang].tips.addSuccess,d.TIMEOUT.timeout1s),a.dismiss(0),n.getPagedDataAsync(n.pagingOptions.pageSize,n.pagingOptions.currentPage,n.filterOptions.filterText)},c.myPost2(d.URL.systemUrl,t.info,d.msgIdName.paySetMsgId,d.msgIdName.paySetMsgName,t.callback2,a),l.pop("wait",constantsLang[n.app.myData.lang].load.reqData,constantsLang[n.app.myData.lang].load.addingData)},t.cancel=function(){console.log(t.info),a.dismiss(0)}}]),n.btnClickAddStation=function(){var t=n.gridOptions.$gridScope.selectedItems;if(0==t.length)l.pop("info",constantsLang[n.app.myData.lang].tips.tip,constantsLang[n.app.myData.lang].tips.noSelectRow);else if(null==t[0].station_id)l.pop("info",constantsLang[n.app.myData.lang].tips.tip,constantsLang[n.app.myData.lang].tips.noAddedStation);else if(null!=t[0].wx_APPID)l.pop("info",constantsLang[n.app.myData.lang].tips.tip,constantsLang[n.app.myData.lang].tips.isAddedToEdit);else{var a=n;e.open({templateUrl:"tpl/system/payset/weixin/addWx.html",controller:"btnClickAddStationCon",size:"md",resolve:{parentScope:a,info:function(){return t[0]}}})}},app.controller("btnClickEditStationCon",["$scope","$uibModalInstance","info","parentScope",function(t,a,e,n){t.parent=n,t.info=e,t.info.weixinSetData={},t.info.weixinSetData.appid=e.wx_APPID,t.info.weixinSetData.sub_appid=e.sub_appid,t.info.weixinSetData.mchid=e.wx_MCHID,t.info.weixinSetData.sub_mch_id=e.sub_mch_id,t.ok=function(){t.info.sessionId=n.app.myData.sessionId,t.info.datatype=d.cmdType.CHANGE,t.info.paySetType=1,console.log(t.info),t.callback3=function(e){l.clear(),l.pop("success",constantsLang[n.app.myData.lang].tips.success,constantsLang[n.app.myData.lang].tips.editSuccess,d.TIMEOUT.timeout1s),a.dismiss(0),void 0!==n.app.myData.stationList&&n.app.myData.stationList.forEach(function(t,a){t.station_id==e.station_id&&(n.app.myData.stationList[a].stationName=e.stationName)}),n.getPagedDataAsync(n.pagingOptions.pageSize,n.pagingOptions.currentPage,n.filterOptions.filterText)},c.myPost2(d.URL.systemUrl,t.info,d.msgIdName.paySetMsgId,d.msgIdName.paySetMsgName,t.callback3,a),l.pop("wait",constantsLang[n.app.myData.lang].load.reqData,constantsLang[n.app.myData.lang].load.editingData)},t.cancel=function(){a.dismiss(0)}}]),n.btnClickEditStation=function(){var t=n.gridOptions.$gridScope.selectedItems;if(console.log(t[0]),0==t.length)l.pop("info",constantsLang[n.app.myData.lang].tips.tip,constantsLang[n.app.myData.lang].tips.noSelectRow);else if(null==t[0].station_id)l.pop("info",constantsLang[n.app.myData.lang].tips.tip,constantsLang[n.app.myData.lang].tips.noAddedStation);else if(null==t[0].wx_APPID)l.pop("info",constantsLang[n.app.myData.lang].tips.tip,constantsLang[n.app.myData.lang].tips.isEditedToAdd);else{var a=n;e.open({templateUrl:"tpl/system/payset/weixin/editWx.html",controller:"btnClickEditStationCon",size:"md",resolve:{parentScope:a,info:function(){return t[0]}}})}},app.controller("btnClickDelStationCon",["$scope","$uibModalInstance","info","parentScope",function(t,a,e,n){t.info=e,t.info.weixinSetData={},t.info.weixinSetData.appid=e.wx_APPID,t.info.weixinSetData.sub_appid=e.sub_appid,t.info.weixinSetData.mchid=e.wx_MCHID,t.info.weixinSetData.sub_mch_id=e.sub_mch_id,t.ok=function(){t.info.sessionId=n.app.myData.sessionId,t.info.datatype=d.cmdType.DEL,t.info.paySetType=1,t.callback3=function(t){l.clear(),l.pop("success",constantsLang[n.app.myData.lang].tips.success,constantsLang[n.app.myData.lang].tips.deleteSuccess,d.TIMEOUT.timeout1s),a.dismiss(0),n.getPagedDataAsync(n.pagingOptions.pageSize,n.pagingOptions.currentPage,n.filterOptions.filterText)},c.myPost2(d.URL.systemUrl,t.info,d.msgIdName.paySetMsgId,d.msgIdName.paySetMsgName,t.callback3,a),l.pop("wait",constantsLang[n.app.myData.lang].load.reqData,constantsLang[n.app.myData.lang].load.deletingData)},t.cancel=function(){a.dismiss(0)}}]),n.btnClickDelStation=function(){var t=n.gridOptions.$gridScope.selectedItems;if(0==t.length)l.pop("info",constantsLang[n.app.myData.lang].tips.tip,constantsLang[n.app.myData.lang].tips.noSelectRow);else if(null==t[0].station_id)l.pop("info",constantsLang[n.app.myData.lang].tips.tip,constantsLang[n.app.myData.lang].tips.noAddedStation);else if(null==t[0].wx_APPID)l.pop("info",constantsLang[n.app.myData.lang].tips.tip,constantsLang[n.app.myData.lang].tips.noAdded);else{var a=n;e.open({templateUrl:"tpl/system/payset/weixin/delWx.html",controller:"btnClickDelStationCon",size:"md",resolve:{parentScope:a,info:function(){return t[0]}}})}},app.controller("btnClickUploadP12",["$scope","$uibModalInstance","info","parentScope",function(i,o,t,p){i.parent=p,i.info=t,i.upload_success=!1,i.tips="",i.disableBtn=!1,i.upload=function(){var n=document.getElementById("btn_uploadP12");(s=document.getElementById("upload_p12_tips")).innerText="",n.setAttribute("disabled",!0);var t=document.getElementById("uploadP12_file").files[0];if(void 0!==t){var a=d.URL.phpReceiveP12FileUrl,e=new FormData;e.append("mf",t),e.append("sessionId",p.app.myData.sessionId),e.append("group_id",i.info.group_id),e.append("station_id",i.info.station_id),console.log(a),$.ajax({url:a,data:e,type:"POST",contentType:!1,processData:!1,success:function(t){console.log(t),function(t){if(n.disabled=!1,t){console.log(t);var a=JSON.parse(t);if(console.log(a),console.log(a.success),1==a.success){n.disabled=!1,n.text="上传成功",i.upload_success=!0,s.innerText="文件上传成功,与服务端同步中..",i.parent.wx_p12=a.data.name;var e={datatype:2,group_id:i.info.group_id,sessionId:p.app.myData.sessionId,station_id:i.info.station_id,paySetType:11,weixinSetData:{wx_p12:i.parent.wx_p12}};i._callback=function(t){l.clear(),l.pop("success",constantsLang[p.app.myData.lang].tips.success,"上传证书文件成功",d.TIMEOUT.timeout1s),o.dismiss(0),p.getPagedDataAsync(p.pagingOptions.pageSize,p.pagingOptions.currentPage,p.filterOptions.filterText)},c.myPost2(d.URL.systemUrl,e,d.msgIdName.paySetMsgId,d.msgIdName.paySetMsgName,i._callback,o)}else console.log("失败失败"),s.innerText="上传失败:"+a.msg}else s.innerText="上传失败"}(t)},error:function(t){console.log(t),s.innerText="上传失败!!"}})}else{n.disabled=!1;var s="未选择文件"}},i.cancel=function(){o.dismiss(0)},i.ok=function(){i.info.sessionId=p.app.myData.sessionId,i.info.datatype=d.cmdType.CHANGE,i.info.paySetType=11,i.info.weixinSetData={},console.log(i.info),void 0===p.wx_p12?upload_p12_tips.innerText="证书文件路径错误":i.info.weixinSetData.wx_p12=p.wx_p12,i.callback3=function(e){l.clear(),l.pop("success",constantsLang[p.app.myData.lang].tips.success,constantsLang[p.app.myData.lang].tips.editSuccess,d.TIMEOUT.timeout1s),o.dismiss(0),void 0!==p.app.myData.stationList&&p.app.myData.stationList.forEach(function(t,a){t.station_id==e.station_id&&(p.app.myData.stationList[a].stationName=e.stationName)}),p.getPagedDataAsync(p.pagingOptions.pageSize,p.pagingOptions.currentPage,p.filterOptions.filterText)}}}]),n.btnUploadP12=function(){var t=n.gridOptions.$gridScope.selectedItems;if(0==t.length)l.pop("info",constantsLang[n.app.myData.lang].tips.tip,constantsLang[n.app.myData.lang].tips.noSelectRow);else if(null==t[0].station_id)l.pop("info",constantsLang[n.app.myData.lang].tips.tip,constantsLang[n.app.myData.lang].tips.noAddedStation);else if(null==t[0].wx_APPID)l.pop("info",constantsLang[n.app.myData.lang].tips.tip,constantsLang[n.app.myData.lang].tips.noAdded);else{var a=n;e.open({templateUrl:"tpl/system/payset/weixin/uploadP12.html",controller:"btnClickUploadP12",size:"md",resolve:{parentScope:a,info:function(){return t[0]}}})}},app.controller("btnClickTestWxPayCon",["$scope","$uibModalInstance","info","parentScope",function(n,s,t,i){n.info=t,n.ok=function(){n.out_trade_no="",n.hasQrcode=!1,n.tips="222";var t=document.getElementById("qrcode_wx");t.innerText="";var e=new QRCode(t,{width:200,height:200}),a={};a.groupId=n.info.group_id,a.stationId=n.info.station_id,a.deviceId="测试微信支付web端",a.clientType=3,n.callback_2=function(t){if(1==t.error)l.pop("error",constantsLang[i.app.myData.lang].tips.error,t.errorMsg,d.TIMEOUT.timeout2s);else{var a=t.data.twoCodeVal;n.out_trade_no=t.data.tradeNo,e.makeCode(a),n.hasQrcode=!0}},c.myPost(d.URL.systemPayUrl,a,d.msgIdName.payLoginMsgId,d.msgIdName.payLoginMsgName).then(function(t){switch(console.log(t),t.data.resCode){case d.resCode.SUCCESS:!function(t){n.sessionId=t.data.data.sessionId;var a={payType:1,subject:"web端微信支付二维码测试",body:"测试支付1分钱",transNo:"00001",amountPay:1};a.sessionId=n.sessionId,c.myPost2(d.URL.systemPayUrl,a,d.msgIdName.payReqPayQRcodeMsgId,d.msgIdName.payReqPayQRcodeMsgName,n.callback_2,s)}(t);break;default:l.pop("error",constantsLang[i.app.myData.lang].tips.error,t.data.resMsg,d.TIMEOUT.timeout1s)}},function(t){l.pop("error",constantsLang[i.app.myData.lang].tips.error,t,d.TIMEOUT.timeout1s)})},n.callback_4=function(t){console.log(t),0==t.error?(l.pop("success",constantsLang[i.app.myData.lang].tips.success,"退款成功，测试完成。该站点微信配置正确，可以正常使用！",d.TIMEOUT.timeout1s),s.dismiss()):l.pop("warning",constantsLang[i.app.myData.lang].tips.wran,t.errorMsg,d.TIMEOUT.timeout1s)},n.callback_3=function(t){if(console.log(t),0==t.error){var a={payType:1,amountPay:1,amountRefund:1};a.tradeNo=n.out_trade_no,a.sessionId=n.sessionId,c.myPost2(d.URL.systemPayUrl,a,d.msgIdName.payReqRefundQRcodeMsgId,d.msgIdName.payReqRefundQRcodeMsgName,n.callback_4,s)}else l.pop("warning",constantsLang[i.app.myData.lang].tips.wran,t.errorMsg,d.TIMEOUT.timeout1s)},n.refund=function(){if(n.hasQrcode)if(""==n.out_trade_no)l.pop("warning",constantsLang[i.app.myData.lang].tips.warn,"未能取到正确商户订单号",d.TIMEOUT.timeout1s);else{var t={};t.tradeNo=n.out_trade_no,t.sessionId=n.sessionId,c.myPost2(d.URL.systemPayUrl,t,d.msgIdName.payReqPayResultMsgId,d.msgIdName.payReqPayResultMsgName,n.callback_3,s)}else l.pop("warning",constantsLang[i.app.myData.lang].tips.wran,"还未获取到二维码",d.TIMEOUT.timeout1s)},n.cancel=function(){s.dismiss(0)}}]),n.btTestWxPay=function(){var t=n.gridOptions.$gridScope.selectedItems;if(0==t.length)l.pop("info",constantsLang[n.app.myData.lang].tips.tip,constantsLang[n.app.myData.lang].tips.noSelectRow);else if(null==t[0].station_id)l.pop("info",constantsLang[n.app.myData.lang].tips.tip,constantsLang[n.app.myData.lang].tips.noAddedStation);else if(null==t[0].wx_APPID)l.pop("info",constantsLang[n.app.myData.lang].tips.tip,constantsLang[n.app.myData.lang].tips.noAdded);else{var a=n;e.open({templateUrl:"tpl/system/payset/weixin/testWxPay.html",controller:"btnClickTestWxPayCon",size:"md",resolve:{parentScope:a,info:function(){return t[0]}}})}}}]);